#!/usr/bin/python3
import re
import shlex
import subprocess
import sys
from datetime import datetime


def list_devices():
    proc = subprocess.run(["openrgb", "-l"], capture_output=True, text=True)
    result = proc.stdout

    matches = re.findall(r"^(\d+):[\w\W]*?Modes: (.*?)$", result, flags=re.M)
    return matches


def turn_rgb(toggle: str):
    if toggle not in ("on", "off"):
        return

    devices = list_devices()
    if not devices:
        return

    now = datetime.now()

    processes = []

    if toggle == "on" and (8 <= now.hour <= 21):
        for device, modes in devices:
            mode = ""
            if "Rainbow" in modes:
                mode = "Rainbow"
            elif "Spectrum Cycle" in modes:
                mode = "'Spectrum Cycle'"
            elif "Breathing" in modes:
                mode = "Breathing"
            elif "Flashing" in modes:
                mode = "Flashing"
            elif "Static" in modes:
                mode = "Static -c 7287fd"
            elif "Direct" in modes:
                mode = "Direct -c 7287fd"
            if mode != "":
                cmd = f"openrgb -d {device} -m {mode}"
                processes.append(
                    subprocess.Popen(
                        shlex.split(cmd),
                        stdout=subprocess.DEVNULL,
                        stderr=subprocess.STDOUT,
                    )
                )
    elif toggle == "off":
        for device, modes in devices:
            mode = ""
            if "Off" in modes:
                mode = "Off"
            elif "Static" in modes:
                mode = "Static -c 000000"
            elif "Direct" in modes:
                mode = "Direct -c 000000"
            if mode != "":
                cmd = f"openrgb -d {device} -m {mode}"
                processes.append(
                    subprocess.Popen(
                        shlex.split(cmd),
                        stdout=subprocess.DEVNULL,
                        stderr=subprocess.STDOUT,
                    )
                )

    if processes:
        for process in processes:
            process.wait()


if __name__ == "__main__":
    if len(sys.argv) == 2:
        turn_rgb(sys.argv[1])
