#!/bin/bash

set -euo pipefail

if command -v termux-wifi-connectioninfo &>/dev/null &&
  [ "$(termux-wifi-connectioninfo | jq -r '.supplicant_state')" != 'COMPLETED' ]; then
  exit
fi

path="${HOME}/Documents/notes"

if command -v termux-setup-storage &>/dev/null; then
  path_out="${HOME}/storage/shared/Documents/notes"
  if [ -d "${path}" ] && [ -d "${path_out}" ]; then
    rsync -a --delete --exclude=".git" "${path_out}/" "${path}"
  fi
fi

if ! [ -d "${HOME}/Documents/notes" ]; then
  git -C "${HOME}/Documents" clone git@github.com:haroldojunios/notes.git
else
  cd "${HOME}/Documents/notes"
  git pull --rebase --autostash
  if [ -n "$(git status --porcelain)" ]; then
    command -v prettier &>/dev/null && prettier **/*.md --write
    git add .
    git commit -m "$(date --utc -Iseconds)"
    git push
  fi
fi

if command -v termux-setup-storage &>/dev/null; then
  mkdir -p "${path_out}"
  rsync -a --delete --exclude=".git" "${path}/" "${path_out}"
fi
