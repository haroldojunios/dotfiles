#!/bin/bash

# <(echo "$inputData")
# <(cat <<< "$inputData")
# <(printf "%s" "$inputData")

trap "exit 0" INT

if ! command -v termux-setup-storage &>/dev/null; then
  ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no -t termux sync-celular
  exit $?
fi

RCLONE_FILTERS="
- /Android/media/com.whatsapp/WhatsApp/.Shared/**
- /Android/media/com.whatsapp/WhatsApp/.StickerThumbs/**
- /Android/media/com.whatsapp/WhatsApp/.Thumbs/**
- /Android/media/com.whatsapp/WhatsApp/.trash/**
- /Android/media/com.whatsapp/WhatsApp/Media/.**
+ /Android/media/com.whatsapp/**
- **/.Trash/**
- **/.thumbnails/**
- **/.trashed*
- /.**
- /Android/**
- /Documents/PC/**
- /Documents/Books/**
- /Download/PC/**
- /Download/log/**
- /Download/.PluginApp/**
- /Download/torrent/**
- /Download/.exmu-cfg1
- /Music/**
- /Pictures/Cam/**
- /documents/PC/**
- /documents/books/**
- /Tachiyomi/**
"

RC_OPTS=(
  --progress
  --transfers=16
  --checkers=32
  --inplace
  --retries=10
  --low-level-retries=20
  --stats-file-name-length=60
  --check-first
  --verbose
)


if rclone lsd "pc:/media/data/Android/" &>/dev/null;then
  rclone "${RC_OPTS[@]}" \
    --filter-from <(printf "%s" "${RCLONE_FILTERS}") \
    copy "/sdcard/" "pc:/media/data/Android/"
  rclone "${RC_OPTS[@]}" --track-renames \
    --exclude='**tmp**' \
    sync "/sdcard/Tachiyomi/" "pc:/media/data/Android/Tachiyomi/"
fi

rclone "${RC_OPTS[@]}" --track-renames \
  --exclude={"*.ini",".thumbnails/**","Playlists/**","Zotify Music/**"} \
  sync "pc:Music/" "/sdcard/Music/"

if command -v termux-setup-storage &>/dev/null; then
  ssh pc fix-mpd-playlists
else
  fix-mpd-playlists
fi &&
  rclone "${RC_OPTS[@]}" --track-renames \
    sync "pc:.local/share/playlists/" "/sdcard/Music/Playlists"
